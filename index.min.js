var init=function(){var R={needTwoImages:"2枚のスクリーンショットを指定してください。",differentSize:"抽出した2枚のプレイレポートのサイズが異なるため結合できません。",checkImage:"差分確認中...",fileTypeNotAllowed:"png、jpgまたはjpegファイルを指定してください。",tooDifferent:"2枚のスクリーンショットが大きく異なるため結合できません。",extract1stReport:"1枚目のカード部分を抽出中...",findMostMatch:"最大一致箇所を抽出中...",extract2ndReport:"2枚目のカード部分を結合中...",createMergedImage:"結合した画像を作成中...",close:"閉じる",cancel:"キャンセル"},T=document.getElementById("inputFile1"),e=document.getElementById("inputFile2"),t=document.getElementById("screenshotPlaceholder"),a=document.getElementById("screenshotLabel"),n=document.getElementById("image1"),l=document.getElementById("image2"),i={divImage1:n,divImage2:l},d=document.getElementById("playReportLabel"),B=document.getElementById("playReport1"),M=document.getElementById("playReport2"),o={divPlayReport1:B,divPlayReport2:M},x=document.getElementById("merged"),r={image1:null,image2:null},h=function(){r.image1=new Image,r.image2=new Image},D=(h(),{uploadedImage1:null,uploadedImage2:null,playReport1:null,playReport2:null,uploadedImageThumbnail1:null,uploadedImageThumbnail2:null,playReportThumbnail1:null,playReportThumbnail2:null,mergedImage:null}),m=function(){D.uploadedImageThumbnail1=document.createElement("canvas"),D.uploadedImageThumbnail1.width=0,D.uploadedImageThumbnail1.height=0,n.firstChild&&n.removeChild(n.firstChild),n.appendChild(D.uploadedImageThumbnail1),D.uploadedImageThumbnail2=document.createElement("canvas"),D.uploadedImageThumbnail2.width=0,D.uploadedImageThumbnail2.height=0,l.firstChild&&l.removeChild(l.firstChild),l.appendChild(D.uploadedImageThumbnail2),D.playReportThumbnail1=document.createElement("canvas"),D.playReportThumbnail1.width=0,D.playReportThumbnail1.height=0,B.firstChild&&B.removeChild(B.firstChild),B.appendChild(D.playReportThumbnail1),D.playReportThumbnail2=document.createElement("canvas"),D.playReportThumbnail2.width=0,D.playReportThumbnail2.height=0,M.firstChild&&M.removeChild(M.firstChild),M.appendChild(D.playReportThumbnail2),k(),D.uploadedImage1=document.createElement("canvas"),D.uploadedImage2=document.createElement("canvas"),D.playReport1=document.createElement("canvas"),D.playReport2=document.createElement("canvas")},k=function(){D.mergedImage=document.createElement("canvas"),D.mergedImage.width=0,D.mergedImage.height=0,"img"===x.lastElementChild.nodeName.toLowerCase()&&x.removeChild(x.lastElementChild),mergedImageFilename=""},L=(m(),{alpha:!1,colorSpace:"srgb",desynchronized:!1,willReadFrequently:!0}),F={colorSpace:"srgb"},g=.2,c=document.getElementById("warning"),s=document.getElementById("warningMessage"),p=document.getElementById("WarningButton"),A=!1;document.getElementById("inputButton1").onclick=function(){document.getElementById("inputFile1").click()};function u(a,n,e){var l,t=W(e&&e.srcElement);"png"!==t&&"jpg"!==t&&"jpeg"!==t?S(R.fileTypeNotAllowed):(n.divWarning.style.display="none",t=e.target.files,(l=new FileReader).readAsDataURL(t[0]),l.onload=function(){var e=l.result,t=n.images["image"+a];t.src=e,t.onload=function(){n.divWarning.style.display="none",n.screenshotLabel.style.display="";var e=n.canvases["uploadedImage"+a],t=(e.width=this.naturalWidth,e.height=this.naturalHeight,e.getContext("2d",L).drawImage(this,0,0,e.width,e.height,0,0,e.width,e.height),y(e,n.canvases["uploadedImageThumbnail"+a],n.divImages["divImage"+a]),n.canvases["playReport"+a]);f(e,t),y(t,n.canvases["playReportThumbnail"+a],n.playReportDivElements["divPlayReport"+a]),n.pPlayReport.style.display="",n.divScreenshotPlaceholder.style.display="none",n.divWarning.style.display="none"}})}document.getElementById("inputButton2").onclick=function(){document.getElementById("inputFile2").click()};var P=function(){var e=(new Date).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replaceAll("/","").replaceAll(":","").replaceAll(" ","-");mergedImageFilename="image-"+e+".png"},W=(document.getElementById("saveButton").addEventListener("click",function(){var e=document.createElement("a");e.href=D.mergedImage.toDataURL("image/png"),e.download=mergedImageFilename,e.click()}),function(e){var t="";try{t=e.value.split(".").pop()}catch(e){}return t}),y=function(e,t,a){var n=new Image,l=Math.ceil(e.width*g),i=Math.ceil(e.height*g);n.onload=function(){a.style.display="",t.width=l,t.height=i;var e=t.getContext("2d",L);e.scale(g,g),e.drawImage(n,0,0)},n.src=e.toDataURL()},f=function(e,t){for(var a=e.getContext("2d",L).getImageData(0,0,e.width,e.height,F),n=document.createElement("canvas").getContext("2d",L).createImageData(e.width,e.height,F),l=a.data,i=n.data,d=0,o=0;o<l.length;){for(var r=0,h=0;h<4*e.width;h+=4){var m=o+h;l[m]<90&&l[m+1]<90&&l[m+2]<90&&r++}if(.8<r/e.width)o+=4*e.width;else for(var g=0;g<4*e.width;g++)i[d++]=l[o++]}for(var a={threshold:90,data:i,actualWidth:0},n=d/(4*e.width),a=(v(a,e.width,n),a.actualWidth||e.width),c=e.getContext("2d",L).createImageData(a,n,F),o=0;o<d;o++)c.data[o]=i[o];t.width=a,t.height=n,t.getContext("2d",L).putImageData(c,0,0,0,0,a,n)},v=function(e,t,a){for(var n=e.threshold,l=e.data,i=Number.MAX_SAFE_INTEGER,d=0,o=4*t*Math.floor(.5*a),r=0;r<10;r++){for(var h=o+4*t*r,m=!0,g=0;g<4*t&&m;g+=4)if(l[c=h+g]>n||l[c+1]>n||l[c+2]>n){m=!1;break}g<i&&(i=g/4)}for(o=4*t*Math.floor(.5*a)-1,r=0;r<10;r++){for(var c,h=o+4*t*r,m=!0,g=0;g<t&&m;g+=4)if(l[(c=h-g)-1]>n||l[c-2]>n||l[c-3]>n){m=!1;break}d<g&&(d=g/4)}for(var s=t-i-d,p=new Uint8ClampedArray(l.length),u=(p.set(l),0),y=0;y<p.length;){for(y+=4*i,r=0;r<4*s;r++)l[u++]=p[y++];y+=4*d}for(;u<l.length;)l[u++]=0;e.actualWidth=s},i={images:r,canvases:D,screenshotLabel:a,divImages:i,pPlayReport:d,divScreenshotPlaceholder:t,playReportDivElements:o,divWarning:c};T.addEventListener("change",u.bind(this,"1",i),!1),e.addEventListener("change",u.bind(this,"2",i),!1);document.getElementById("resetButton").onclick=function(){T.value="",e.value="",h(),m(),a.style.display="none",n.style.display="none",d.style.display="none",B.style.display="none",M.style.display="none",t.style.display="",x.style.display="none",c.style.display="none",s.textContent="",p.style.display="none"};document.getElementById("mergeButton").onclick=function(){if("none"===B.style.display||"none"===M.style.display)S(R.needTwoImages);else{x.style.display="none",k();var e=D.playReport1,t=D.playReport2,a=e.getContext("2d",L).getImageData(0,0,e.width,e.height,F),n=t.getContext("2d",L).getImageData(0,0,t.width,t.height,F);if(a.width!==n.width||a.height!==n.height)S(R.differentSize);else{for(var l=a.data,i=n.data,e=document.createElement("canvas"),t=3145728/a.width,t=Math.floor(Math.min(1.4*a.height,t)),d=e.getContext("2d",L).createImageData(a.width,t,F).data,e=W(T),o="jpg"===e||"jpeg"===e,r=(S(R.checkImage,R.cancel,N),A=!0,0),h=0;h<l.length&&h<i.length&&A;){for(var m=0,g=0;g<4*a.width;g+=4){var c=h+g;if(c+3>l.length||c+3>i.length)break;!(o&&10<Math.abs(l[c]-i[c])&&10<Math.abs(l[c+1]-i[c+1])&&10<Math.abs(l[c+2]-i[c+2]))&&(o||l[c]===i[c]&&l[c+1]===i[c+1]&&l[c+2]===i[c+2])||m++}h+=4*a.width,0<m&&r++}if(.6<r/a.height)S(R.tooDifferent);else{U(R.extract1stReport);for(var s=0,p=0,u=0,y=4*a.width*Math.floor(.81*a.height);p<y&&s<d.length&&A;)d[s++]=l[p++];p-=4*a.width;var u=4*n.width*Math.floor(.5*n.height),f=!1,v=0,I=0;for(U(R.findMostMatch),h=u;h<i.length&&!f&&A;h+=4*n.width){for(m=0,g=0;g<4*a.width;g+=4){var w=p+g,E=h+g;if(w+3>l.length||E+3>i.length){f=!0;break}!(o&&Math.abs(l[w]-i[E])<10&&Math.abs(l[w+1]-i[E+1])<10&&Math.abs(l[w+2]-i[E+2])<10)&&(o||l[w]!==i[E]||l[w+1]!==i[E+1]||l[w+2]!==i[E+2])||m++}var b=m/n.width;v<b&&(v=b,I=h)}for(u=I,U(R.extract2ndReport);u<i.length&&s<d.length&&A;)d[s++]=i[u++];A=!1,U(R.createMergedImage);for(var t=s/(4*a.width),e=D.mergedImage,C=e.getContext("2d",L).createImageData(a.width,t,F),h=0;h<s;h++)C.data[h]=d[h];x.style.display="",e.width=a.width,e.height=t,e.getContext("2d",L).putImageData(C,0,0,0,0,a.width,t),j(),P(),z()}}}};var S=function(e,t,a){s.textContent=e,t&&a?(p.textContent=t,p.onclick=a,p.style.display=""):p.style.display="none",c.style.display="block"},j=function(){s.textContent="",p.textContent="",c.style.display="none",p.style.display="none"},N=function(){A=!1,j()},U=function(e){s.textContent=e},z=function(){var e=document.createElement("img");e.src=D.mergedImage.toDataURL("image/png"),x.appendChild(e)}};init();