var init=function(){var w={title:"リンクラ プレイレポート結合",explanation1:"リンクラのプレイレポート画像2枚を結合します。<br/>例：",plus:"+",arrow:"=>",explanation2:"画像ファイルはどこにもアップロードされません。ファイルの結合はご使用の端末上で実行されます。",explanation3:"処理時間は端末の性能や使用状況により異なります。解像度の高い端末のスクリーンショットは画像サイズが大きくなるため、処理に時間がかかる場合があります。また、バッテリー消費も大きくなります。",explanation4:"スクリーンショット1にはカード部分の最上部が、スクリーンショット2にはカード部分の最下部が表示されている画像をそれぞれ指定してください。逆に指定すると正しく結合されません。",explanation5:"編集していないスクリーンショットを使用してください。トリミング等の編集を行った画像では正しく処理できない場合があります。",explanation6:"「LIVE CLEAR!」と表示され、背景やスコアが完全に表示された後でプレイレポートを表示し、両方のスクリーンショットを撮ってください。背景が異なると差分を正しく抽出できません。",explanation7:"免責事項：いかなる場合も、本ツールの利用に起因もしくは関連して発生した間接的、偶発的、結果的損害に対して一切の責任と義務を負いません。",explanation8:"動作確認済みブラウザ：iPhone 12/iOS 16/Sarafi, Xperia 5 II/Android 12/Chrome",version:"version: 0.5",screenshotButtonLabel1:"スクリーンショット 1：",screenshotButtonLabel2:"スクリーンショット 2：",selectFile:"ファイルを選択",reset:"リセット",merge:"結合",screenshotPlaceholderDescription:"選択したスクリーンショットと、抽出したプレイレポート部分がここに表示されます。",screenshotPlaceholderDescription2:"結合ボタンを押すと、プレイレポートを結合した画像が原寸大で最下部に表示されます。",screenshot:"スクリーンショット",playReport:"プレイレポート",mergedImage:"結合後の画像",needTwoImages:"2枚のスクリーンショットを指定してください。",differentSize:"抽出した2枚のプレイレポートのサイズが異なるため結合できません。",checkImage:"差分確認中...",fileTypeNotAllowed:"png、jpgまたはjpegファイルを指定してください。",tooDifferent:"2枚のスクリーンショットが大きく異なるため結合できません。",extract1stReport:"1枚目のカード部分を抽出中...",findMostMatch:"最大一致箇所を抽出中...",extract2ndReport:"2枚目のカード部分を結合中...",createMergedImage:"結合した画像を作成中...",saveImage:"画像を保存",saveNote:"「画像を保存」ボタンが効かない場合は画像を右クリックまたは長押しして保存してください。",close:"閉じる",cancel:"キャンセル"},b=(document.title=w.title,document.getElementById("explanation1").innerHTML=w.explanation1,document.getElementById("plus").innerHTML=w.plus,document.getElementById("arrow").innerHTML=w.arrow,document.getElementById("explanation2").textContent=w.explanation2,document.getElementById("explanation3").textContent=w.explanation3,document.getElementById("explanation4").textContent=w.explanation4,document.getElementById("explanation5").textContent=w.explanation5,document.getElementById("explanation6").textContent=w.explanation6,document.getElementById("explanation7").textContent=w.explanation7,document.getElementById("explanation8").textContent=w.explanation8,document.getElementById("version").textContent=w.version,document.getElementById("inputLabel1").textContent=w.screenshotButtonLabel1,document.getElementById("inputButton1").textContent=w.selectFile,document.getElementById("inputLabel2").textContent=w.screenshotButtonLabel2,document.getElementById("inputButton2").textContent=w.selectFile,document.getElementById("resetButton").textContent=w.reset,document.getElementById("mergeButton").textContent=w.merge,document.getElementById("screenshotPlaceholderDescription").textContent=w.screenshotPlaceholderDescription,document.getElementById("screenshotPlaceholderDescription2").textContent=w.screenshotPlaceholderDescription2,document.getElementById("mergeButton").textContent=w.merge,document.getElementById("screenshotLabel").textContent=w.screenshot,document.getElementById("playReportLabel").textContent=w.playReport,document.getElementById("mergedImageLabel").textContent=w.mergedImage,document.getElementById("saveButton").textContent=w.saveImage,document.getElementById("saveNote").textContent=w.saveNote,document.getElementById("inputFile1")),e=document.getElementById("inputFile2"),t=document.getElementById("screenshotPlaceholder"),n=document.getElementById("screenshotLabel"),a=document.getElementById("image1"),l=document.getElementById("image2"),o={divImage1:a,divImage2:l},i=document.getElementById("playReportLabel"),R=document.getElementById("playReport1"),T=document.getElementById("playReport2"),d={divPlayReport1:R,divPlayReport2:T},L=document.getElementById("merged"),r={image1:null,image2:null},m=function(){r.image1=new Image,r.image2=new Image},D=(m(),{uploadedImage1:null,uploadedImage2:null,playReport1:null,playReport2:null,uploadedImageThumbnail1:null,uploadedImageThumbnail2:null,playReportThumbnail1:null,playReportThumbnail2:null,mergedImage:null}),g=function(){D.uploadedImageThumbnail1=document.createElement("canvas"),D.uploadedImageThumbnail1.width=0,D.uploadedImageThumbnail1.height=0,a.firstChild&&a.removeChild(a.firstChild),a.appendChild(D.uploadedImageThumbnail1),D.uploadedImageThumbnail2=document.createElement("canvas"),D.uploadedImageThumbnail2.width=0,D.uploadedImageThumbnail2.height=0,l.firstChild&&l.removeChild(l.firstChild),l.appendChild(D.uploadedImageThumbnail2),D.playReportThumbnail1=document.createElement("canvas"),D.playReportThumbnail1.width=0,D.playReportThumbnail1.height=0,R.firstChild&&R.removeChild(R.firstChild),R.appendChild(D.playReportThumbnail1),D.playReportThumbnail2=document.createElement("canvas"),D.playReportThumbnail2.width=0,D.playReportThumbnail2.height=0,T.firstChild&&T.removeChild(T.firstChild),T.appendChild(D.playReportThumbnail2),M(),D.uploadedImage1=document.createElement("canvas"),D.uploadedImage2=document.createElement("canvas"),D.playReport1=document.createElement("canvas"),D.playReport2=document.createElement("canvas")},M=function(){D.mergedImage=document.createElement("canvas"),D.mergedImage.width=0,D.mergedImage.height=0,"img"===L.lastElementChild.nodeName.toLowerCase()&&L.removeChild(L.lastElementChild),mergedImageFilename=""},k=(g(),{alpha:!1,colorSpace:"srgb",desynchronized:!1,willReadFrequently:!0}),P={colorSpace:"srgb"},c=.2,h=document.getElementById("warning"),s=document.getElementById("warningMessage"),p=document.getElementById("WarningButton"),F=!1;document.getElementById("inputButton1").onclick=function(){document.getElementById("inputFile1").click()};function u(n,a,e){var l,t=S(e&&e.srcElement);"png"!==t&&"jpg"!==t&&"jpeg"!==t?W(w.fileTypeNotAllowed):(a.divWarning.style.display="none",t=e.target.files,(l=new FileReader).readAsDataURL(t[0]),l.onload=function(){var e=l.result,t=a.images["image"+n];t.src=e,t.onload=function(){a.divWarning.style.display="none",a.screenshotLabel.style.display="";var e=a.canvases["uploadedImage"+n],t=(e.width=this.naturalWidth,e.height=this.naturalHeight,e.getContext("2d",k).drawImage(this,0,0,e.width,e.height,0,0,e.width,e.height),y(e,a.canvases["uploadedImageThumbnail"+n],a.divImages["divImage"+n]),a.canvases["playReport"+n]);I(e,t),y(t,a.canvases["playReportThumbnail"+n],a.playReportDivElements["divPlayReport"+n]),a.pPlayReport.style.display="",a.divScreenshotPlaceholder.style.display="none",a.divWarning.style.display="none"}})}document.getElementById("inputButton2").onclick=function(){document.getElementById("inputFile2").click()};var A=function(){var e=(new Date).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replaceAll("/","").replaceAll(":","").replaceAll(" ","-");mergedImageFilename="image-"+e+".png"},S=(document.getElementById("saveButton").addEventListener("click",function(){var e=document.createElement("a");e.href=D.mergedImage.toDataURL("image/png"),e.download=mergedImageFilename,e.click()}),function(e){var t="";try{t=e.value.split(".").pop()}catch(e){}return t}),y=function(e,t,n){var a=new Image,l=Math.ceil(e.width*c),o=Math.ceil(e.height*c);a.onload=function(){n.style.display="",t.width=l,t.height=o;var e=t.getContext("2d",k);e.scale(c,c),e.drawImage(a,0,0)},a.src=e.toDataURL()},I=function(e,t){for(var n=e.getContext("2d",k).getImageData(0,0,e.width,e.height,P),a=document.createElement("canvas").getContext("2d",k).createImageData(e.width,e.height,P),l=n.data,o=a.data,i=0,d=0;d<l.length;){for(var r=0,m=0;m<4*e.width;m+=4){var g=d+m;l[g]<90&&l[g+1]<90&&l[g+2]<90&&r++}if(.8<r/e.width)d+=4*e.width;else for(var c=0;c<4*e.width;c++)o[i++]=l[d++]}for(var n={threshold:90,data:o,actualWidth:0},a=i/(4*e.width),n=(v(n,e.width,a),n.actualWidth||e.width),h=e.getContext("2d",k).createImageData(n,a,P),d=0;d<i;d++)h.data[d]=o[d];t.width=n,t.height=a,t.getContext("2d",k).putImageData(h,0,0,0,0,n,a)},v=function(e,t,n){for(var a=e.threshold,l=e.data,o=Number.MAX_SAFE_INTEGER,i=0,d=4*t*Math.floor(.5*n),r=0;r<10;r++){for(var m=d+4*t*r,g=!0,c=0;c<4*t&&g;c+=4)if(l[h=m+c]>a||l[h+1]>a||l[h+2]>a){g=!1;break}c<o&&(o=c/4)}for(d=4*t*Math.floor(.5*n)-1,r=0;r<10;r++){for(var h,m=d+4*t*r,g=!0,c=0;c<t&&g;c+=4)if(l[(h=m-c)-1]>a||l[h-2]>a||l[h-3]>a){g=!1;break}i<c&&(i=c/4)}for(var s=t-o-i,p=new Uint8ClampedArray(l.length),u=(p.set(l),0),y=0;y<p.length;){for(y+=4*o,r=0;r<4*s;r++)l[u++]=p[y++];y+=4*i}for(;u<l.length;)l[u++]=0;e.actualWidth=s},o={images:r,canvases:D,screenshotLabel:n,divImages:o,pPlayReport:i,divScreenshotPlaceholder:t,playReportDivElements:d,divWarning:h};b.addEventListener("change",u.bind(this,"1",o),!1),e.addEventListener("change",u.bind(this,"2",o),!1);document.getElementById("resetButton").onclick=function(){b.value="",e.value="",m(),g(),n.style.display="none",a.style.display="none",i.style.display="none",R.style.display="none",T.style.display="none",t.style.display="",L.style.display="none",h.style.display="none",s.textContent="",p.style.display="none"};document.getElementById("mergeButton").onclick=function(){if("none"===R.style.display||"none"===T.style.display)W(w.needTwoImages);else{L.style.display="none",M();var e=D.playReport1,t=D.playReport2,n=e.getContext("2d",k).getImageData(0,0,e.width,e.height,P),a=t.getContext("2d",k).getImageData(0,0,t.width,t.height,P);if(n.width!==a.width||n.height!==a.height)W(w.differentSize);else{for(var l=n.data,o=a.data,e=document.createElement("canvas"),t=3145728/n.width,t=Math.floor(Math.min(1.4*n.height,t)),i=e.getContext("2d",k).createImageData(n.width,t,P).data,e=S(b),d="jpg"===e||"jpeg"===e,r=(W(w.checkImage,w.cancel,j),F=!0,0),m=0;m<l.length&&m<o.length&&F;){for(var g=0,c=0;c<4*n.width;c+=4){var h=m+c;if(h+3>l.length||h+3>o.length)break;!(d&&10<Math.abs(l[h]-o[h])&&10<Math.abs(l[h+1]-o[h+1])&&10<Math.abs(l[h+2]-o[h+2]))&&(d||l[h]===o[h]&&l[h+1]===o[h+1]&&l[h+2]===o[h+2])||g++}m+=4*n.width,0<g&&r++}if(.6<r/n.height)W(w.tooDifferent);else{U(w.extract1stReport);for(var s=0,p=0,u=0,y=4*n.width*Math.floor(.81*n.height);p<y&&s<i.length&&F;)i[s++]=l[p++];p-=4*n.width;var u=4*a.width*Math.floor(.5*a.height),I=!1,v=0,f=0;for(U(w.findMostMatch),m=u;m<o.length&&!I&&F;m+=4*a.width){for(g=0,c=0;c<4*n.width;c+=4){var E=p+c,x=m+c;if(E+3>l.length||x+3>o.length){I=!0;break}!(d&&Math.abs(l[E]-o[x])<10&&Math.abs(l[E+1]-o[x+1])<10&&Math.abs(l[E+2]-o[x+2])<10)&&(d||l[E]!==o[x]||l[E+1]!==o[x+1]||l[E+2]!==o[x+2])||g++}var C=g/a.width;v<C&&(v=C,f=m)}for(u=f,U(w.extract2ndReport);u<o.length&&s<i.length&&F;)i[s++]=o[u++];F=!1,U(w.createMergedImage);for(var t=s/(4*n.width),e=D.mergedImage,B=e.getContext("2d",k).createImageData(n.width,t,P),m=0;m<s;m++)B.data[m]=i[m];L.style.display="",e.width=n.width,e.height=t,e.getContext("2d",k).putImageData(B,0,0,0,0,n.width,t),N(),A(),H()}}}};var W=function(e,t,n){s.textContent=e,t&&n?(p.textContent=t,p.onclick=n,p.style.display=""):p.style.display="none",h.style.display="block"},N=function(){s.textContent="",p.textContent="",h.style.display="none",p.style.display="none"},j=function(){F=!1,N()},U=function(e){s.textContent=e},H=function(){var e=document.createElement("img");e.src=D.mergedImage.toDataURL("image/png"),L.appendChild(e)}};init();