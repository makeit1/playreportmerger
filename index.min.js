let init=function(){let u={title:"リンクラ プレイレポート結合",explanation1:"リンクラのプレイレポート画像2枚を結合します。<br/>例：",explanation2:"画像ファイルはどこにもアップロードされません。ファイルの結合はご使用の端末上で実行されます。",explanation3:"処理時間は端末の性能や使用状況により異なります。解像度の高い端末のスクリーンショットは画像サイズが大きくなるため、処理に時間がかかる場合があります。また、バッテリー消費も大きくなります。",explanation4:"スクリーンショット1にはカード部分の最上部が、スクリーンショット2にはカード部分の最下部が表示されている画像をそれぞれ指定してください。逆に指定すると正しく結合されません。",explanation5:"「LIVE CLEAR!」と表示され、背景やスコアが完全に表示された後でプレイレポートを表示し、両方のスクリーンショットを撮ってください。背景が異なると差分を正しく抽出できません。",explanation6:"免責事項：いかなる場合も、本ツールの利用に起因もしくは関連して発生した間接的、偶発的、結果的損害に対して一切の責任と義務を負いません。",screenshotButtonLabel1:"スクリーンショット 1：",screenshotButtonLabel2:"スクリーンショット 2：",reset:"リセット",merge:"結合",screenshotPlaceholderDescription:"選択したスクリーンショットと、抽出したプレイレポート部分がここに表示されます。",screenshotPlaceholderDescription2:"結合ボタンを押すと、プレイレポートを結合した画像が原寸大で最下部に表示されます。",screenshot1:"スクリーンショット 1",screenshot2:"スクリーンショット 2",playReport1:"プレイレポート 1",playReport2:"プレイレポート 2",mergedImage:"結合後の画像",needTwoImages:"2枚のスクリーンショットを指定してください。",differentSize:"2枚のスクリーンショットのサイズが異なるため結合できません。",checkImage:"差分確認中...",tooDifferent:"2枚のスクリーンショットが大きく異なるため結合できません。",extractCommonPart:"共通部分（スコアとグラフ）抽出中...",extract1stReport:"1枚目のカード部分を抽出中...",extract2ndReport:"2枚目のカード部分を抽出中...",createMergedImage:"結合した画像を作成中...",close:"閉じる",cancel:"キャンセル"},e=(document.title=u.title,document.getElementById("explanation1").innerHTML=u.explanation1,document.getElementById("explanation2").textContent=u.explanation2,document.getElementById("explanation3").textContent=u.explanation3,document.getElementById("explanation4").textContent=u.explanation4,document.getElementById("explanation5").textContent=u.explanation5,document.getElementById("explanation6").textContent=u.explanation6,document.getElementById("input1").textContent=u.screenshotButtonLabel1,document.getElementById("input2").textContent=u.screenshotButtonLabel2,document.getElementById("resetButton").textContent=u.reset,document.getElementById("mergeButton").textContent=u.merge,document.getElementById("screenshotPlaceholderDescription").textContent=u.screenshotPlaceholderDescription,document.getElementById("screenshotPlaceholderDescription2").textContent=u.screenshotPlaceholderDescription2,document.getElementById("mergeButton").textContent=u.merge,document.getElementById("screenshotLabel1").textContent=u.screenshot1,document.getElementById("screenshotLabel2").textContent=u.screenshot2,document.getElementById("trimmedImageLabel1").textContent=u.playReport1,document.getElementById("trimmedImageLabel2").textContent=u.playReport2,document.getElementById("mergedImageLabel").textContent=u.mergedImage,document.getElementById("inputFile1")),t=document.getElementById("inputFile2"),m=document.getElementById("screenshotPlaceholder"),c=document.getElementById("screenshots"),n=document.getElementById("image1");var o=document.getElementById("canvas1");let a=o.getContext("2d"),l=document.getElementById("image2");var d=document.getElementById("canvas2");let i=d.getContext("2d"),p=document.getElementById("trimmedImage1"),I=document.getElementById("trimmedImage2"),x=document.getElementById("merged"),f=document.getElementById("canvas3"),E=f.getContext("2d");var r=new Image,g=new Image;let B=document.createElement("canvas"),C=document.createElement("canvas");var s=document.getElementById("canvas1_trimmed"),h=document.getElementById("canvas2_trimmed");let y=s.getContext("2d"),w=h.getContext("2d"),v=.2,b=document.getElementById("popupWrapper"),D=document.getElementById("popupMessage"),L=document.getElementById("popupCloseButton"),R=!1;function P(n,o,a,l,d,i,r,e){b.style.display="none",e=e.target.files;let t=new FileReader;t.readAsDataURL(e[0]),t.onload=function(){var e=t.result;n.src=e,n.onload=function(){"none"!==b.style.display&&(b.style.display="none",c.style.display=""),l.style.display="";var e=n.width*v,t=n.height*v;o.width=e,o.height=t,a.drawImage(n,0,0,e,t),d.width=n.width,d.height=n.height,d.getContext("2d",{willReadFrequently:!0}).drawImage(n,0,0,n.width,n.height),F(d),A(d,i,r),m.style.display="none"}}}let A=function(e,t,n){let o=new Image,a=e.width*v,l=e.height*v;o.onload=function(){n.style.display="",t.width=a,t.height=l;var e=t.getContext("2d");e.scale(v,v),e.drawImage(o,0,0)},o.src=e.toDataURL()},F=function(o){var e=o.getContext("2d").getImageData(0,0,o.width,o.height),t=document.createElement("canvas").getContext("2d").createImageData(o.width,o.height),a=e.data,l=t.data;let d=0;for(let n=0;n<a.length;){let t=0;for(let e=0;e<4*o.width;e+=4)a[n+e]<90&&a[n+e+1]<90&&a[n+e+2]<90&&t++;if(.8<t/o.width)n+=4*o.width;else for(let e=0;e<4*o.width;e+=4)l[d++]=a[n++]}var e=d/(4*o.width),n=o.getContext("2d").createImageData(o.width,e);for(let e=0;e<d;e++)n.data[e]=l[e];o.height=e,o.getContext("2d").putImageData(n,0,0)};e.addEventListener("change",P.bind(this,r,o,a,n,B,s,p),!1),t.addEventListener("change",P.bind(this,g,d,i,l,C,h,I),!1);document.getElementById("resetButton").onclick=function(){e.value="",t.value="",a.reset(),i.reset(),E.reset(),y.reset(),w.reset(),n.style.display="none",l.style.display="none",p.style.display="none",I.style.display="none",m.style.display="",x.style.display="none",b.style.display="none",D.textContent=""};document.getElementById("mergeButton").onclick=function(){if("none"===p.style.display||"none"===I.style.display)M(u.needTwoImages,u.close,_);else{x.style.display="none",E.reset();var t=B.getContext("2d").getImageData(0,0,B.width,B.height),n=C.getContext("2d").getImageData(0,0,C.width,C.height);if(t.width!==n.width||t.height!==n.height)M(u.differentSize,u.close,_);else{var d=t.data,i=n.data,r=document.createElement("canvas").getContext("2d").createImageData(2*B.width,2*B.height).data;let o=0,a=0,l=0;M(u.checkImage,u.cancel,T),console.log("check diff rate"),R=!0;let e=0;for(let n=0;n<d.length&&n<i.length&&R;){let t=0;for(let e=0;e<4*B.width;e+=4){var m=n+e;if(m+3>d.length||m+3>i.length)break;d[m]===i[m]&&d[m+1]===i[m+1]&&d[m+2]===i[m+2]||t++,n+=4}0<t&&e++}if(console.log("num of diff rows: "+e),console.log("height: "+B.height),console.log("diff rate: "+e/B.height),.5<e/B.height)M(u.tooDifferent,u.close,_);else{N(u.extractCommonPart);for(let n=0;n<d.length&&R;n+=4){let t=0;for(let e=0;e<4*B.width;e+=4){var c=a+e,g=l+e;if(c+3>d.length||g+3>i.length){n=Number.MAX_SAFE_INTEGER;break}d[c]===i[g]&&d[c+1]===i[g+1]&&d[c+2]===i[g+2]&&t++}if(!(.8<t/B.width))break;for(k=0;k<4*B.width;k++)r[o++]=d[a++],l++}N(u.extract1stReport);for(let n=a;n<d.length&&R;n+=4){let t=0;for(let e=0;e<4*B.width;e+=4){var s=a+e,h=l+e;if(s+3>d.length||h+3>i.length){n=Number.MAX_SAFE_INTEGER;break}d[s]===i[h]&&d[s+1]===i[h+1]&&d[s+2]===i[h+2]&&t++}if(!(t/B.width<.3))break;for(k=0;k<4*B.width;k++)r[o++]=d[a++]}for(N(u.extract2ndReport);l<i.length&&R;)r[o++]=i[l++];N(u.createMergedImage);var t=o/(4*B.width),y=f.getContext("2d").createImageData(B.width,t);for(let e=0;e<o;e++)y.data[e]=r[e];x.style.display="",f.width=B.width,f.height=t,f.getContext("2d").putImageData(y,0,0),_()}}}};let M=function(e,t,n){D.textContent=e,L.textContent=t,L.onclick=n,b.style.display="block"},_=function(){D.textContent="",L.textContent="",b.style.display="none"},T=function(){R=!1,_()},N=function(e){D.textContent=e}};init();