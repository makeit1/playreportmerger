var init=function(){var T={needTwoImages:"2枚のスクリーンショットを指定してください。",differentSize:"抽出した2枚のプレイレポートのサイズが異なるため結合できません。",checkImage:"差分確認中...",fileTypeNotAllowed:"png、jpgまたはjpegファイルを指定してください。",tooDifferent:"2枚のスクリーンショットが大きく異なるため結合できません。",extract1stReport:"1枚目のカード部分を抽出中...",findMostMatch:"最大一致箇所を抽出中...",extract2ndReport:"2枚目のカード部分を結合中...",createMergedImage:"結合した画像を作成中...",close:"閉じる",cancel:"キャンセル"},x=document.getElementById("inputFile1"),e=document.getElementById("inputFile2"),t=document.getElementById("screenshotPlaceholder"),a=document.getElementById("screenshotLabel"),n=document.getElementById("image1"),l=document.getElementById("image2"),i={divImage1:n,divImage2:l},d=document.getElementById("playReportLabel"),M=document.getElementById("playReport1"),D=document.getElementById("playReport2"),o={divPlayReport1:M,divPlayReport2:D},k=document.getElementById("merged"),r={image1:null,image2:null},h=function(){r.image1=new Image,r.image2=new Image},L=(h(),{uploadedImage1:null,uploadedImage2:null,playReport1:null,playReport2:null,uploadedImageThumbnail1:null,uploadedImageThumbnail2:null,playReportThumbnail1:null,playReportThumbnail2:null,mergedImage:null}),m=function(){L.uploadedImageThumbnail1=document.createElement("canvas"),L.uploadedImageThumbnail1.width=0,L.uploadedImageThumbnail1.height=0,n.firstChild&&n.removeChild(n.firstChild),n.appendChild(L.uploadedImageThumbnail1),L.uploadedImageThumbnail2=document.createElement("canvas"),L.uploadedImageThumbnail2.width=0,L.uploadedImageThumbnail2.height=0,l.firstChild&&l.removeChild(l.firstChild),l.appendChild(L.uploadedImageThumbnail2),L.playReportThumbnail1=document.createElement("canvas"),L.playReportThumbnail1.width=0,L.playReportThumbnail1.height=0,M.firstChild&&M.removeChild(M.firstChild),M.appendChild(L.playReportThumbnail1),L.playReportThumbnail2=document.createElement("canvas"),L.playReportThumbnail2.width=0,L.playReportThumbnail2.height=0,D.firstChild&&D.removeChild(D.firstChild),D.appendChild(L.playReportThumbnail2),F(),L.uploadedImage1=document.createElement("canvas"),L.uploadedImage2=document.createElement("canvas"),L.playReport1=document.createElement("canvas"),L.playReport2=document.createElement("canvas")},F=function(){L.mergedImage=document.createElement("canvas"),L.mergedImage.width=0,L.mergedImage.height=0,"img"===k.lastElementChild.nodeName.toLowerCase()&&k.removeChild(k.lastElementChild),mergedImageFilename=""},A=(m(),{alpha:!1,colorSpace:"srgb",desynchronized:!1,willReadFrequently:!0}),P={colorSpace:"srgb"},g=.2,c=document.getElementById("warning"),s=document.getElementById("warningMessage"),p=document.getElementById("WarningButton"),W=!1;document.getElementById("inputButton1").onclick=function(){document.getElementById("inputFile1").click()};function u(a,n,e){var l,t=j(e&&e.srcElement);"png"!==t&&"jpg"!==t&&"jpeg"!==t?N(T.fileTypeNotAllowed):(n.divWarning.style.display="none",t=e.target.files,(l=new FileReader).readAsDataURL(t[0]),l.onload=function(){var e=l.result,t=n.images["image"+a];t.src=e,t.onload=function(){n.divWarning.style.display="none",n.screenshotLabel.style.display="";var e=n.canvases["uploadedImage"+a],t=(e.width=this.naturalWidth,e.height=this.naturalHeight,e.getContext("2d",A).drawImage(this,0,0,e.width,e.height,0,0,e.width,e.height),y(e,n.canvases["uploadedImageThumbnail"+a],n.divImages["divImage"+a]),n.canvases["playReport"+a]);f(e,t),y(t,n.canvases["playReportThumbnail"+a],n.playReportDivElements["divPlayReport"+a]),n.pPlayReport.style.display="",n.divScreenshotPlaceholder.style.display="none",n.divWarning.style.display="none"}})}document.getElementById("inputButton2").onclick=function(){document.getElementById("inputFile2").click()};var S=function(){var e=(new Date).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replaceAll("/","").replaceAll(":","").replaceAll(" ","-");mergedImageFilename="image-"+e+".png"},j=(document.getElementById("saveButton").addEventListener("click",function(){var e=document.createElement("a");e.href=L.mergedImage.toDataURL("image/png"),e.download=mergedImageFilename,e.click()}),function(e){var t="";try{t=e.value.split(".").pop()}catch(e){}return t}),y=function(e,t,a){var n=new Image,l=Math.ceil(e.width*g),i=Math.ceil(e.height*g);n.onload=function(){a.style.display="",t.width=l,t.height=i;var e=t.getContext("2d",A);e.scale(g,g),e.drawImage(n,0,0)},n.src=e.toDataURL()},f=function(e,t){for(var a=e.getContext("2d",A).getImageData(0,0,e.width,e.height,P),n=document.createElement("canvas").getContext("2d",A).createImageData(e.width,e.height,P),l=a.data,i=n.data,d=0,o=0;o<l.length;){for(var r=0,h=0;h<4*e.width;h+=4){var m=o+h;l[m]<90&&l[m+1]<90&&l[m+2]<90&&r++}if(.8<r/e.width)o+=4*e.width;else for(var g=0;g<4*e.width;g++)i[d++]=l[o++]}for(var a={threshold:90,data:i,actualWidth:0},n=d/(4*e.width),a=(v(a,e.width,n),a.actualWidth||e.width),c=e.getContext("2d",A).createImageData(a,n,P),o=0;o<d;o++)c.data[o]=i[o];t.width=a,t.height=n,t.getContext("2d",A).putImageData(c,0,0,0,0,a,n)},v=function(e,t,a){for(var n=e.threshold,l=e.data,i=Number.MAX_SAFE_INTEGER,d=0,o=4*t*Math.floor(.5*a),r=0;r<10;r++){for(var h=o+4*t*r,m=!0,g=0;g<4*t&&m;g+=4)if(l[c=h+g]>n||l[c+1]>n||l[c+2]>n){m=!1;break}g<i&&(i=g/4)}for(o=4*t*Math.floor(.5*a)-1,r=0;r<10;r++){for(var c,h=o+4*t*r,m=!0,g=0;g<t&&m;g+=4)if(l[(c=h-g)-1]>n||l[c-2]>n||l[c-3]>n){m=!1;break}d<g&&(d=g/4)}for(var s=t-i-d,p=new Uint8ClampedArray(l.length),u=(p.set(l),0),y=0;y<p.length;){for(y+=4*i,r=0;r<4*s;r++)l[u++]=p[y++];y+=4*d}for(;u<l.length;)l[u++]=0;e.actualWidth=s},i={images:r,canvases:L,screenshotLabel:a,divImages:i,pPlayReport:d,divScreenshotPlaceholder:t,playReportDivElements:o,divWarning:c};x.addEventListener("change",u.bind(this,"1",i),!1),e.addEventListener("change",u.bind(this,"2",i),!1);document.getElementById("resetButton").onclick=function(){x.value="",e.value="",h(),m(),a.style.display="none",n.style.display="none",d.style.display="none",M.style.display="none",D.style.display="none",t.style.display="",k.style.display="none",c.style.display="none",s.textContent="",p.style.display="none"};document.getElementById("mergeButton").onclick=function(){if("none"===M.style.display||"none"===D.style.display)N(T.needTwoImages);else{k.style.display="none",F();var e=L.playReport1,t=L.playReport2,a=e.getContext("2d",A).getImageData(0,0,e.width,e.height,P),n=t.getContext("2d",A).getImageData(0,0,t.width,t.height,P);if(a.width!==n.width||a.height!==n.height)N(T.differentSize);else{for(var l=a.data,i=n.data,e=document.createElement("canvas"),t=document.getElementById("checkbox1").checked,d=3145728/a.width,o=1.4*a.height,t=t?o:Math.floor(Math.min(o,d)),r=e.getContext("2d",A).createImageData(a.width,t,P).data,o=j(x),h="jpg"===o||"jpeg"===o,m=(N(T.checkImage,T.cancel,z),W=!0,0),g=0;g<l.length&&g<i.length&&W;){for(var c=0,s=0;s<4*a.width;s+=4){var p=g+s;if(p+3>l.length||p+3>i.length)break;!(h&&10<Math.abs(l[p]-i[p])&&10<Math.abs(l[p+1]-i[p+1])&&10<Math.abs(l[p+2]-i[p+2]))&&(h||l[p]===i[p]&&l[p+1]===i[p+1]&&l[p+2]===i[p+2])||c++}g+=4*a.width,0<c&&m++}if(.6<m/a.height)N(T.tooDifferent);else{_(T.extract1stReport);for(var u=0,y=0,f=0,v=4*a.width*Math.floor(.81*a.height);y<v&&u<r.length&&W;)r[u++]=l[y++];y-=4*a.width;var f=4*n.width*Math.floor(.5*n.height),I=!1,w=0,E=0;for(_(T.findMostMatch),g=f;g<i.length&&!I&&W;g+=4*n.width){for(c=0,s=0;s<4*a.width;s+=4){var b=y+s,C=g+s;if(b+3>l.length||C+3>i.length){I=!0;break}!(h&&Math.abs(l[b]-i[C])<10&&Math.abs(l[b+1]-i[C+1])<10&&Math.abs(l[b+2]-i[C+2])<10)&&(h||l[b]!==i[C]||l[b+1]!==i[C+1]||l[b+2]!==i[C+2])||c++}var R=c/n.width;w<R&&(w=R,E=g)}for(f=E,_(T.extract2ndReport);f<i.length&&u<r.length&&W;)r[u++]=i[f++];W=!1,_(T.createMergedImage);for(var d=u/(4*a.width),e=L.mergedImage,B=e.getContext("2d",A).createImageData(a.width,d,P),g=0;g<u;g++)B.data[g]=r[g];k.style.display="",e.width=a.width,e.height=d,e.getContext("2d",A).putImageData(B,0,0,0,0,a.width,d),U(),S(),q()}}}};var N=function(e,t,a){s.textContent=e,t&&a?(p.textContent=t,p.onclick=a,p.style.display=""):p.style.display="none",c.style.display="block"},U=function(){s.textContent="",p.textContent="",c.style.display="none",p.style.display="none"},z=function(){W=!1,U()},_=function(e){s.textContent=e},q=function(){var e=document.createElement("img");e.src=L.mergedImage.toDataURL("image/png"),k.appendChild(e)}};init();