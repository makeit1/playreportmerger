var init=function(){var M={needTwoImages:"3枚のスクリーンショットを指定してください。",differentSize:"抽出した3枚のプレイレポートのサイズが異なるため結合できません。",checkImage:"差分確認中...",fileTypeNotAllowed:"png、jpgまたはjpegファイルを指定してください。",tooDifferent:"3枚のスクリーンショットが大きく異なるため結合できません。",extract1stReport:"1枚目のカード部分を抽出中...",findMostMatch:"最大一致箇所を抽出中...",extract2ndReport:"2枚目のカード部分を結合中...",createMergedImage:"結合した画像を作成中...",close:"閉じる",cancel:"キャンセル"},i=document.getElementById("inputFile1"),e=document.getElementById("inputFile2"),t=document.getElementById("inputFile3"),a=document.getElementById("screenshotPlaceholder"),n=document.getElementById("screenshotLabel"),l=document.getElementById("image1"),d=document.getElementById("image2"),o=document.getElementById("image3"),h={divImage1:l,divImage2:d,divImage3:o},m=document.getElementById("playReportLabel"),r=document.getElementById("playReport1"),g=document.getElementById("playReport2"),c=document.getElementById("playReport3"),u={divPlayReport1:r,divPlayReport2:g,divPlayReport3:c},k=document.getElementById("merged"),p={image1:null,image2:null,image3:null},s=function(){p.image1=new Image,p.image2=new Image,p.image3=new Image},D=(s(),{uploadedImage1:null,uploadedImage2:null,playReport1:null,playReport2:null,playReport3:null,uploadedImageThumbnail1:null,uploadedImageThumbnail2:null,uploadedImageThumbnail3:null,playReportThumbnail1:null,playReportThumbnail2:null,playReportThumbnail3:null,mergedImage:null,mergedImageAll:null}),y=function(){D.uploadedImageThumbnail1=document.createElement("canvas"),D.uploadedImageThumbnail1.width=0,D.uploadedImageThumbnail1.height=0,l.firstChild&&l.removeChild(l.firstChild),l.appendChild(D.uploadedImageThumbnail1),D.uploadedImageThumbnail2=document.createElement("canvas"),D.uploadedImageThumbnail2.width=0,D.uploadedImageThumbnail2.height=0,d.firstChild&&d.removeChild(d.firstChild),d.appendChild(D.uploadedImageThumbnail2),D.uploadedImageThumbnail3=document.createElement("canvas"),D.uploadedImageThumbnail3.width=0,D.uploadedImageThumbnail3.height=0,o.firstChild&&o.removeChild(o.firstChild),o.appendChild(D.uploadedImageThumbnail3),D.playReportThumbnail1=document.createElement("canvas"),D.playReportThumbnail1.width=0,D.playReportThumbnail1.height=0,r.firstChild&&r.removeChild(r.firstChild),r.appendChild(D.playReportThumbnail1),D.playReportThumbnail2=document.createElement("canvas"),D.playReportThumbnail2.width=0,D.playReportThumbnail2.height=0,g.firstChild&&g.removeChild(g.firstChild),g.appendChild(D.playReportThumbnail2),D.playReportThumbnail3=document.createElement("canvas"),D.playReportThumbnail3.width=0,D.playReportThumbnail3.height=0,c.firstChild&&c.removeChild(c.firstChild),c.appendChild(D.playReportThumbnail3),I(),D.uploadedImage1=document.createElement("canvas"),D.uploadedImage2=document.createElement("canvas"),D.uploadedImage3=document.createElement("canvas"),D.playReport1=document.createElement("canvas"),D.playReport2=document.createElement("canvas"),D.playReport3=document.createElement("canvas")},I=function(){D.mergedImage=document.createElement("canvas"),D.mergedImage.width=0,D.mergedImage.height=0,D.mergedImageAll=document.createElement("canvas"),D.mergedImageAll.width=0,D.mergedImageAll.height=0,"img"===k.lastElementChild.nodeName.toLowerCase()&&k.removeChild(k.lastElementChild),mergedImageFilename=""},A=(y(),{alpha:!1,colorSpace:"srgb",desynchronized:!1,willReadFrequently:!0}),L={colorSpace:"srgb"},v=.2,f=document.getElementById("warning"),w=document.getElementById("warningMessage"),b=document.getElementById("WarningButton"),F=!1;document.getElementById("inputButton1").onclick=function(){document.getElementById("inputFile1").click()},document.getElementById("inputButton2").onclick=function(){document.getElementById("inputFile2").click()};function E(a,n,e){var l,t=C(e&&e.srcElement);"png"!==t&&"jpg"!==t&&"jpeg"!==t?W(M.fileTypeNotAllowed):(n.divWarning.style.display="none",t=e.target.files,(l=new FileReader).readAsDataURL(t[0]),l.onload=function(){var e=l.result,t=n.images["image"+a];t.src=e,t.onload=function(){n.divWarning.style.display="none",n.screenshotLabel.style.display="";var e=n.canvases["uploadedImage"+a],t=(e.width=this.naturalWidth,e.height=this.naturalHeight,e.getContext("2d",A).drawImage(this,0,0,e.width,e.height,0,0,e.width,e.height),R(e,n.canvases["uploadedImageThumbnail"+a],n.divImages["divImage"+a]),n.canvases["playReport"+a]);B(e,t),R(t,n.canvases["playReportThumbnail"+a],n.playReportDivElements["divPlayReport"+a]),n.pPlayReport.style.display="",n.divScreenshotPlaceholder.style.display="none",n.divWarning.style.display="none"}})}document.getElementById("inputButton3").onclick=function(){document.getElementById("inputFile3").click()};var P=function(){var e=(new Date).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replaceAll("/","").replaceAll(":","").replaceAll(" ","-");mergedImageFilename="image-"+e+".png"},C=(document.getElementById("saveButton").addEventListener("click",function(){var e=document.createElement("a");e.href=D.mergedImageAll.toDataURL("image/png"),e.download=mergedImageFilename,e.click()}),function(e){var t="";try{t=e.value.split(".").pop()}catch(e){}return t}),R=function(e,t,a){var n=new Image,l=Math.ceil(e.width*v),i=Math.ceil(e.height*v);n.onload=function(){a.style.display="",t.width=l,t.height=i;var e=t.getContext("2d",A);e.scale(v,v),e.drawImage(n,0,0)},n.src=e.toDataURL()},B=function(e,t){for(var a=e.getContext("2d",A).getImageData(0,0,e.width,e.height,L),n=document.createElement("canvas").getContext("2d",A).createImageData(e.width,e.height,L),l=a.data,i=n.data,d=0,o=0;o<l.length;){for(var h=0,m=0;m<4*e.width;m+=4){var r=o+m;l[r]<90&&l[r+1]<90&&l[r+2]<90&&h++}if(.8<h/e.width)o+=4*e.width;else for(var g=0;g<4*e.width;g++)i[d++]=l[o++]}for(var a={threshold:90,data:i,actualWidth:0},n=d/(4*e.width),a=(x(a,e.width,n),a.actualWidth||e.width),c=e.getContext("2d",A).createImageData(a,n,L),o=0;o<d;o++)c.data[o]=i[o];t.width=a,t.height=n,t.getContext("2d",A).putImageData(c,0,0,0,0,a,n)},x=function(e,t,a){for(var n=e.threshold,l=e.data,i=Number.MAX_SAFE_INTEGER,d=0,o=4*t*Math.floor(.5*a),h=0;h<10;h++){for(var m=o+4*t*h,r=!0,g=0;g<4*t&&r;g+=4)if(l[c=m+g]>n||l[c+1]>n||l[c+2]>n){r=!1;break}g<i&&(i=g/4)}for(o=4*t*Math.floor(.5*a)-1,h=0;h<10;h++){for(var c,m=o+4*t*h,r=!0,g=0;g<t&&r;g+=4)if(l[(c=m-g)-1]>n||l[c-2]>n||l[c-3]>n){r=!1;break}d<g&&(d=g/4)}for(var u=t-i-d,p=new Uint8ClampedArray(l.length),s=(p.set(l),0),y=0;y<p.length;){for(y+=4*i,h=0;h<4*u;h++)l[s++]=p[y++];y+=4*d}for(;s<l.length;)l[s++]=0;e.actualWidth=u},h={images:p,canvases:D,screenshotLabel:n,divImages:h,pPlayReport:m,divScreenshotPlaceholder:a,playReportDivElements:u,divWarning:f};i.addEventListener("change",E.bind(this,"1",h),!1),e.addEventListener("change",E.bind(this,"2",h),!1),t.addEventListener("change",E.bind(this,"3",h),!1);document.getElementById("resetButton").onclick=function(){i.value="",e.value="",t.value="",s(),y(),n.style.display="none",l.style.display="none",m.style.display="none",r.style.display="none",g.style.display="none",c.style.display="none",a.style.display="",k.style.display="none",f.style.display="none",w.textContent="",b.style.display="none"};var u=document.getElementById("mergeButton"),N=function(e,t,a,n){for(var l=e.data,i=t.data,d=Math.floor(.3*e.height),o=d*e.width*4;o<l.length&&o<i.length;){for(var h=0,m=0;m<4*e.width;m+=4){var r=o+m;if(r+3>l.length||r+3>i.length)break;!(a&&Math.abs(l[r]-i[r])>n&&Math.abs(l[r+1]-i[r+1])>n&&Math.abs(l[r+2]-i[r+2])>n)&&(a||l[r]===i[r]&&l[r+1]===i[r+1]&&l[r+2]===i[r+2])||h++}if(.1<h/e.width)return d--;d++,o+=4*e.width}},U=function(e,t,a,n){for(var l=e.data,i=t.data,d=e.height-15,o=d*e.width*4;o<l.length&&o<i.length;){for(var h=0,m=0;m<4*e.width;m+=4){var r=o+m;if(r+3>l.length||r+3>i.length)break;!(a&&Math.abs(l[r]-i[r])>n&&Math.abs(l[r+1]-i[r+1])>n&&Math.abs(l[r+2]-i[r+2])>n)&&(a||l[r]===i[r]&&l[r+1]===i[r+1]&&l[r+2]===i[r+2])||h++}if(.05<h/e.width)return d++,e.height-d;--d,o-=4*e.width}},T=function(e,t,a,n,l,i,d){for(var o=e.data,h=t.data,m=document.createElement("canvas"),r=document.getElementById("checkbox1").checked,g=3145728/e.width,c=1.4*e.height,r=r?c:Math.floor(Math.min(c,g)),u=m.getContext("2d",A).createImageData(e.width,r,L).data,p=(W(M.checkImage,M.cancel,z),F=!0,j(M.extract1stReport),0),s=0,y=0,I=4*e.width*(e.height-n-30);s<I&&p<u.length&&F;)u[p++]=o[s++];s-=4*e.width;var y=4*t.width*(a+10),v=!1,f=0,w=0;j(M.findMostMatch);for(var b=y;b<h.length&&!v&&F;b+=4*t.width){for(var E=0,C=0;C<4*e.width;C+=4){var R=s+C,T=b+C;if(R+3>o.length||T+3>h.length){v=!0;break}!(l&&Math.abs(o[R]-h[T])<i&&Math.abs(o[R+1]-h[T+1])<i&&Math.abs(o[R+2]-h[T+2])<i)&&(l||o[R]!==h[T]||o[R+1]!==h[T+1]||o[R+2]!==h[T+2])||E++}var B=E/t.width;f<B&&(f=B,w=b)}for(y=w,j(M.extract2ndReport);y<h.length&&p<u.length&&F;)u[p++]=h[y++];F=!1,j(M.createMergedImage);for(var c=p/(4*e.width),x=(g=d?D.mergedImage:D.mergedImageAll).getContext("2d",A).createImageData(e.width,c,L),b=0;b<p;b++)x.data[b]=u[b];if(k.style.display="",g.width=e.width,g.height=c,g.getContext("2d",A).putImageData(x,0,0,0,0,e.width,c),S(),d)return g;P(),_()},W=(u.onclick=function(){var e,t,a,n,l;"none"===r.style.display||"none"===g.style.display?W(M.needTwoImages):(k.style.display="none",I(),n=D.playReport1,l=D.playReport2,e=D.playReport3,n=n.getContext("2d",A).getImageData(0,0,n.width,n.height,L),l=l.getContext("2d",A).getImageData(0,0,l.width,l.height,L),e=e.getContext("2d",A).getImageData(0,0,e.width,e.height,L),n.width!==l.width||n.height!==l.height||n.height!==e.height?W(M.differentSize):(C(i),t=N(n,l,!0,10),a=U(n,l,!0,10),l=(n=T(n,l,t,a,!0,30,!0)).getContext("2d",A).getImageData(0,0,n.width,n.height,L),T(l,e,t,a,!0,30,!1)))},function(e,t,a){w.textContent=e,t&&a?(b.textContent=t,b.onclick=a,b.style.display=""):b.style.display="none",f.style.display="block"}),S=function(){w.textContent="",b.textContent="",f.style.display="none",b.style.display="none"},z=function(){F=!1,S()},j=function(e){w.textContent=e},_=function(){var e=document.createElement("img");e.src=D.mergedImageAll.toDataURL("image/png"),k.appendChild(e)}};init();